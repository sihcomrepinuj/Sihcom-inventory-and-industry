{% extends "base.html" %}
{% block title %}{{ product_name }} â€” Chain Shopping List{% endblock %}

{% block content %}
<hgroup>
    <h2>Chain Shopping List: {{ product_name }}</h2>
    <p>{{ bp_name }} &mdash; ME {{ me }}, {{ runs }} run{{ 's' if runs != 1 else '' }}{% if structure_bonus > 0 %}, structure bonus -{{ structure_bonus }}%{% endif %}, sub-ME {{ sub_me }}</p>
</hgroup>

<form method="get" action="/chain/shopping/{{ bp_id }}" class="controls">
    <label>
        ME
        <select name="me">
            {% for level in range(11) %}
            <option value="{{ level }}" {% if level == me %}selected{% endif %}>{{ level }}</option>
            {% endfor %}
        </select>
    </label>
    <label>
        Runs
        <input type="number" name="runs" value="{{ runs }}" min="1" style="width:6rem">
    </label>
    <label>
        Structure Bonus %
        <input type="number" name="structure_bonus" value="{{ structure_bonus }}" min="0" step="0.1" style="width:6rem">
    </label>
    <label>
        Sub-ME
        <select name="sub_me">
            {% for level in range(11) %}
            <option value="{{ level }}" {% if level == sub_me %}selected{% endif %}>{{ level }}</option>
            {% endfor %}
        </select>
    </label>
    <label>
        <input type="checkbox" name="reactions" value="1" {% if resolve_reactions %}checked{% endif %}>
        Resolve reactions
    </label>
    {% if has_corp %}
    <label>
        Assets
        <select name="source">
            <option value="corp" {% if source == 'corp' %}selected{% endif %}>Corporation</option>
            <option value="personal" {% if source == 'personal' %}selected{% endif %}>Personal</option>
        </select>
    </label>
    {% endif %}
    <input type="hidden" name="buy" value="{{ buy_param }}">
    <button type="submit">Update</button>
</form>

<p class="text-muted">
    Showing <strong>{{ 'corporation' if source == 'corp' else 'personal' }}</strong> assets.
    {% if buy_param %}
    Some components set to <strong>buy</strong> (not resolved to raw materials).
    {% else %}
    All components resolved to raw materials.
    {% endif %}
</p>

{% if materials %}
<table>
    <thead>
        <tr>
            <th>Material</th>
            <th class="text-right">Need</th>
            <th class="text-right">Have</th>
            <th class="text-right">Buy</th>
            <th class="text-right">Jita Sell</th>
            <th class="text-right">Est. Cost</th>
            <th class="text-right">Status</th>
        </tr>
    </thead>
    <tbody>
        {% for mat in materials %}
        <tr>
            <td><a href="/market/{{ mat.type_id }}">{{ mat.name }}</a></td>
            <td class="text-right">{{ mat.quantity | commas }}</td>
            <td class="text-right">{{ mat.have | commas }}</td>
            <td class="text-right">{{ mat.deficit | commas }}</td>
            <td class="text-right">{{ mat.sell_price | isk }}</td>
            <td class="text-right">{{ mat.buy_cost | isk }}</td>
            <td class="text-right">
                {% if mat.deficit == 0 %}
                    <span class="status-ok">OK</span>
                {% else %}
                    <span class="status-need">NEED</span>
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </tbody>
    <tfoot>
        <tr>
            <td colspan="5" class="text-right grand-total">Estimated Buy Cost</td>
            <td class="text-right grand-total">{{ total_buy_cost | isk }} ISK</td>
            <td></td>
        </tr>
    </tfoot>
</table>

{% set missing = materials | selectattr('deficit', 'greaterthan', 0) | list | length %}
{% if missing == 0 %}
<p class="status-ok"><strong>All materials on hand. Ready to build!</strong></p>
{% else %}
<p>Missing <strong>{{ missing }}</strong> material{{ 's' if missing != 1 else '' }}.
<button class="outline" id="btn-multibuy" onclick="copyMultibuy()" style="margin-left:1rem;">Copy to Multibuy</button>
</p>
{% endif %}
{% else %}
<p>No materials found for this blueprint chain.</p>
{% endif %}

<p><a href="/chain/{{ bp_id }}?me={{ me }}&runs={{ runs }}&structure_bonus={{ structure_bonus }}&sub_me={{ sub_me }}&reactions={{ '1' if resolve_reactions else '0' }}">&larr; Back to chain view</a></p>
{% endblock %}

{% block scripts %}
<script>
function copyMultibuy() {
    const items = [
        {% for mat in materials %}
        {% if mat.deficit > 0 %}
        { name: {{ mat.name | tojson }}, qty: {{ mat.deficit }} },
        {% endif %}
        {% endfor %}
    ];
    const text = items.map(i => `${i.name} ${i.qty}`).join('\n');
    navigator.clipboard.writeText(text).then(() => {
        const btn = document.getElementById('btn-multibuy');
        btn.textContent = 'Copied!';
        setTimeout(() => { btn.textContent = 'Copy to Multibuy'; }, 2000);
    });
}
</script>
{% endblock %}
